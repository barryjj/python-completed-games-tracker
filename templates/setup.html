<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Steam Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .card { background-color: #161b22; border: 1px solid #30363d; }
        .input-style { background-color: #0d1117; border-color: #30363d; color: #c9d1d9; }
        .btn-primary { background-color: #238636; }
        .btn-primary:hover { background-color: #2ea043; }
        .btn-secondary { background-color: #30363d; }
        .btn-secondary:hover { background-color: #484f58; }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-lg">
        <h1 class="text-4xl font-bold text-white mb-6 text-center">
            Application Setup
        </h1>
        <p class="text-gray-400 text-center mb-8">
            Enter your Steam API Key and User ID to initialize the tracker.
        </p>
        
        <div id="statusMessage" class="hidden p-4 mb-6 rounded-lg font-semibold transition duration-300"></div>

        <div class="card p-8 rounded-xl shadow-2xl">
            
            <form id="setupForm" method="POST" action="{{ url_for('setup') }}" class="space-y-6">
                
                <!-- Steam API Key Input -->
                <div>
                    <label for="steam_api_key" class="block text-sm font-medium mb-2">Steam Web API Key</label>
                    <input type="text" id="steam_api_key" name="steam_api_key" 
                           value="{{ current_key or '' }}" required 
                           class="input-style w-full p-3 rounded-lg border focus:ring-blue-500 focus:border-blue-500"
                           placeholder="e.g., A1B2C3D4E5F67890">
                    <p class="mt-1 text-xs text-gray-500">
                        Get yours from: <a href="https://steamcommunity.com/dev/apikey" target="_blank" class="text-blue-400 hover:underline">steamcommunity.com/dev/apikey</a>
                    </p>
                </div>

                <!-- Steam User ID Input -->
                <div>
                    <label for="steam_user_id" class="block text-sm font-medium mb-2">Steam User ID (64-bit)</label>
                    <input type="text" id="steam_user_id" name="steam_user_id" 
                           value="{{ current_user_id or '' }}" required 
                           class="input-style w-full p-3 rounded-lg border focus:ring-blue-500 focus:border-blue-500"
                           placeholder="e.g., 76561198000000000">
                    <p class="mt-1 text-xs text-gray-500">
                        This is the unique 17-digit ID for your profile.
                    </p>
                </div>

                <!-- Current Status Badge -->
                {% if current_key and current_user_id %}
                <div class="text-center pt-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-900 text-green-300">
                        <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        Credentials are currently set. Submitting will update them.
                    </span>
                </div>
                {% endif %}

                <!-- Submission Button -->
                <div class="pt-4">
                    <button type="submit" id="submitBtn" class="w-full btn-primary text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
                        Save and Verify Credentials
                    </button>
                </div>
            </form>
        </div>

        <!-- Go back to Dashboard if credentials exist -->
        {% if current_key and current_user_id %}
        <div class="text-center mt-6">
            <a href="{{ url_for('index_or_setup') }}" class="btn-secondary text-white font-bold py-2 px-4 rounded-lg transition duration-150 inline-block shadow-md">
                Go to Dashboard
            </a>
        </div>
        {% endif %}
    </div>
    
    <script>
        const statusMessage = document.getElementById('statusMessage');

        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `p-4 mb-6 rounded-lg font-semibold transition duration-300 ${isError ? 'bg-red-700 text-white' : 'bg-green-700 text-white'}`;
            statusMessage.classList.remove('hidden');
        }

        const form = document.getElementById('setupForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Verifying...';
            submitBtn.disabled = true;

            const formData = new FormData(form);
            
            try {
                // Post data to the setup route
                const response = await fetch('{{ url_for('setup') }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Object.fromEntries(formData))
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(data.message, false);
                    setTimeout(() => {
                        // Redirect to the index page after successful setup and library sync
                        window.location.href = '{{ url_for('index_or_setup') }}';
                    }, 1500);
                } else {
                    showStatus(data.error || 'Setup failed due to an unknown error.', true);
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}. Is the server running?`, true);
            } finally {
                submitBtn.textContent = 'Save and Verify Credentials';
                submitBtn.disabled = false;
            }
        });

        // Display flash messages from the server on initial load
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    // Display server message, treating 'error' category as an error
                    showStatus(message, category === 'error');
                {% endfor %}
            {% endif %}
        {% endwith %}
    </script>
</body>
</html>