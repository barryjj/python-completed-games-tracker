{% extends "base.html" %}

{% block title %}Setup - Steam Tracker{% endblock %}

{% block content %}
    <div class="w-full max-w-lg mx-auto">
        <h1 class="text-4xl font-extrabold text-white mb-6 text-center">
            Initial Setup
        </h1>

        <div class="card p-6 sm:p-8 rounded-xl shadow-xl">
            <!-- Navigation Links -->
            <div class="flex justify-between mb-6 border-b border-gray-700 pb-4">
                <!-- FIX: Changed 'views.index' to the correct 'views.index_or_setup' endpoint -->
                <a href="{{ url_for('views.index_or_setup') }}" class="btn-secondary py-2 px-4 rounded-lg font-semibold shadow-md flex items-center">
                    ‚Üê Back to Dashboard
                </a>
                <a href="{{ url_for('views.view_log') }}" class="btn-secondary py-2 px-4 rounded-lg font-semibold shadow-md flex items-center">
                    Completed Log
                </a>
            </div>

            <!-- Instructions -->
            <p class="text-gray-400 mb-6 text-sm">
                To start tracking your games, we need your Steam API Key and your Steam ID. This allows the application to fetch your game library.
                <a href="https://steamcommunity.com/dev/apikey" target="_blank" class="text-blue-400 hover:text-blue-300 font-semibold transition duration-150 block mt-2">
                    Get your **Steam Web API Key** here (Requires a $5 purchase history).
                </a>
                <a href="https://steamid.io/" target="_blank" class="text-blue-400 hover:text-blue-300 font-semibold transition duration-150 block mt-1">
                    Find your **Steam ID** here.
                </a>
            </p>

            <!-- Status Message Area -->
            <div id="statusMessage" class="hidden p-3 mb-4 rounded-xl text-sm font-medium" role="alert"></div>

            <form id="setupForm" class="space-y-6">
                <!-- Steam API Key Input -->
                <div>
                    <label for="steam_api_key" class="block text-sm font-medium text-gray-300 mb-1">Steam Web API Key</label>
                    <input type="text" 
                           id="steam_api_key" 
                           name="steam_api_key" 
                           value="{{ config.steam_api_key | default('') }}"
                           required 
                           class="input-style w-full p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           placeholder="Enter your API Key">
                </div>

                <!-- Steam ID Input -->
                <div>
                    <label for="steam_id" class="block text-sm font-medium text-gray-300 mb-1">Your Steam ID (e.g., 76561198...)</label>
                    <input type="text" 
                           id="steam_id" 
                           name="steam_id" 
                           value="{{ config.steam_id | default('') }}"
                           required 
                           class="input-style w-full p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           placeholder="Enter your 64-bit Steam ID">
                </div>
                
                <!-- Save Button -->
                <button type="submit" id="submitBtn" class="btn-primary w-full py-3 rounded-lg font-bold text-lg shadow-lg">
                    Save and Verify Credentials
                </button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Helper function for showing status messages
        function showStatus(message, isError) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-700', 'bg-green-700');
            
            if (isError) {
                statusMessage.classList.add('bg-red-700');
            } else {
                statusMessage.classList.add('bg-green-700');
            }
        }
        
        // --- Form Submission Handler ---
        document.getElementById('setupForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;

            const formData = new FormData(this);
            
            // CRITICAL: Convert FormData to JSON Object for Flask endpoint
            const jsonPayload = Object.fromEntries(formData);

            try {
                // Submit data as JSON. Using {{ url_for('views.setup') }} for the POST route
                const response = await fetch('{{ url_for('views.setup') }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonPayload) 
                });

                // Server responded (status 200, 400, 500, etc.)
                const data = await response.json();

                if (response.ok) {
                    showStatus(data.message, false);
                    setTimeout(() => {
                        // FIX: Updated redirect to 'views.index_or_setup'
                        window.location.href = '{{ url_for('views.index_or_setup') }}';
                    }, 1500);
                } else {
                    // Server returned an error, display it
                    showStatus(data.error || 'Setup failed due to an unknown server error.', true);
                }
            } catch (error) {
                // This block handles network errors (e.g., server not running)
                showStatus(`Network error: ${error.message}. Is the server running?`, true);
            } finally {
                submitBtn.textContent = 'Save and Verify Credentials';
                submitBtn.disabled = false;
            }
        });
        
        // --- Flash Message Logic (If Flask flash messages are used) ---
        // Note: For this form submission, we rely on the JS status messages, 
        // but this logic is generally useful for redirects.

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    showStatus("{{ message | e }}", category == 'error');
                {% endfor %}
            {% endif %}
        {% endwith %}
    </script>
{% endblock %}